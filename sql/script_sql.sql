

CREATE TABLE UTILISATEUR (
    id_utilisateur NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    login_db VARCHAR2(50) NOT NULL UNIQUE,
    nom VARCHAR2(100),
    prenom VARCHAR2(100),
    email VARCHAR2(150) NOT NULL UNIQUE,
    telephone VARCHAR2(20),
    mot_de_passe VARCHAR2(200),
    role_app VARCHAR2(30),
    date_inscription DATE DEFAULT SYSDATE
);

CREATE TABLE PROPRIETAIRE (
    id_utilisateur NUMBER PRIMARY KEY,
    CONSTRAINT fk_proprietaire_util FOREIGN KEY (id_utilisateur) REFERENCES UTILISATEUR(id_utilisateur)
);


CREATE TABLE LOCATAIRE (
    id_utilisateur NUMBER PRIMARY KEY,
    CONSTRAINT fk_locataire_util FOREIGN KEY (id_utilisateur) REFERENCES UTILISATEUR(id_utilisateur)
);


CREATE TABLE BIEN (
    id_bien NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    titre VARCHAR2(100) NOT NULL,
    description VARCHAR2(500),
    adresse VARCHAR2(150),
    ville VARCHAR2(50),
    surface NUMBER,
    prix NUMBER(12,2),
    type_bien VARCHAR2(30),
    capacite NUMBER DEFAULT 2,          
    note_moyenne NUMBER(3,1) DEFAULT 0, 
    id_proprietaire NUMBER NOT NULL,
    CONSTRAINT fk_bien_proprietaire FOREIGN KEY (id_proprietaire) REFERENCES PROPRIETAIRE(id_utilisateur)
);


CREATE TABLE PHOTO_BIEN (
    id_photo NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    url_photo VARCHAR2(500) NOT NULL,
    description_alt VARCHAR2(100),
    est_principale NUMBER(1) DEFAULT 0, -- 1 = Photo de couverture, 0 = Galerie
    id_bien NUMBER NOT NULL,
    CONSTRAINT fk_photo_bien FOREIGN KEY (id_bien) REFERENCES BIEN(id_bien) ON DELETE CASCADE
);

CREATE TABLE TYPE_EQUIPEMENT (
    id_equipement NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nom_equipement VARCHAR2(50) NOT NULL UNIQUE,
    icone_url VARCHAR2(200)
);

CREATE TABLE BIEN_EQUIPEMENT (
    id_bien NUMBER,
    id_equipement NUMBER,
    CONSTRAINT pk_bien_equip PRIMARY KEY (id_bien, id_equipement),
    CONSTRAINT fk_be_bien FOREIGN KEY (id_bien) REFERENCES BIEN(id_bien) ON DELETE CASCADE,
    CONSTRAINT fk_be_equip FOREIGN KEY (id_equipement) REFERENCES TYPE_EQUIPEMENT(id_equipement)
);


CREATE TABLE ANNONCE (
    id_annonce NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    date_publication DATE DEFAULT SYSDATE,
    statut VARCHAR2(20) DEFAULT 'disponible',
    id_bien NUMBER NOT NULL,
    CONSTRAINT fk_annonce_bien FOREIGN KEY (id_bien) REFERENCES BIEN(id_bien)
);



CREATE TABLE RESERVATION (
    id_reservation NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_locataire NUMBER NOT NULL,
    id_bien NUMBER NOT NULL,
    id_annonce NUMBER,
    date_demande DATE DEFAULT SYSDATE,
    date_debut DATE NOT NULL,
    date_fin DATE NOT NULL,
    statut VARCHAR2(20) DEFAULT 'EN_ATTENTE', -- EN_ATTENTE, CONFIRMEE, REFUSEE, ANNULEE
    commentaire VARCHAR2(500),
    montant_reservation NUMBER(12,2),
    CONSTRAINT fk_res_locataire FOREIGN KEY (id_locataire) REFERENCES LOCATAIRE(id_utilisateur),
    CONSTRAINT fk_res_bien FOREIGN KEY (id_bien) REFERENCES BIEN(id_bien),
    CONSTRAINT fk_res_annonce FOREIGN KEY (id_annonce) REFERENCES ANNONCE(id_annonce),
    CONSTRAINT chk_dates_res CHECK (date_fin > date_debut)
);

CREATE TABLE LOCATION (
    id_location NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_reservation NUMBER NOT NULL,
    date_debut DATE NOT NULL,
    date_fin DATE NOT NULL,
    montant NUMBER(12,2),
    CONSTRAINT fk_loc_reservation FOREIGN KEY (id_reservation) REFERENCES RESERVATION(id_reservation)
);

CREATE TABLE PAIEMENT (
    id_paiement NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    montant NUMBER(12,2) NOT NULL,
    date_paiement DATE DEFAULT SYSDATE,
    id_location NUMBER NOT NULL,
    statut_paiement VARCHAR2(20) DEFAULT 'EN_ATTENTE', -- EN_ATTENTE, REUSSI, ECHOUE, REMBOURSE
    methode VARCHAR2(50),
    CONSTRAINT fk_pai_loc FOREIGN KEY (id_location) REFERENCES LOCATION(id_location)
);


CREATE TABLE AVIS_BIEN (
    id_avis NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    note NUMBER(1) CHECK (note BETWEEN 1 AND 5),
    commentaire VARCHAR2(1000),
    date_avis DATE DEFAULT SYSDATE,
    id_location NUMBER NOT NULL,
    CONSTRAINT fk_avis_location FOREIGN KEY (id_location) REFERENCES LOCATION(id_location),
    CONSTRAINT uq_avis_location UNIQUE (id_location)
);

CREATE TABLE AVIS_LOCATAIRE (
    id_avis NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    note NUMBER(1) CHECK (note BETWEEN 1 AND 5),
    commentaire VARCHAR2(500),
    id_location NUMBER NOT NULL,
    CONSTRAINT fk_avis_loc_loc FOREIGN KEY (id_location) REFERENCES LOCATION(id_location)
);


CREATE TABLE MESSAGE (
    id_message NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    contenu VARCHAR2(1000) NOT NULL,
    date_envoi TIMESTAMP DEFAULT SYSTIMESTAMP,
    id_expediteur NUMBER NOT NULL,
    id_destinataire NUMBER NOT NULL,
    id_bien NUMBER, -- Contexte
    est_lu NUMBER(1) DEFAULT 0,
    CONSTRAINT fk_msg_exp FOREIGN KEY (id_expediteur) REFERENCES UTILISATEUR(id_utilisateur),
    CONSTRAINT fk_msg_dest FOREIGN KEY (id_destinataire) REFERENCES UTILISATEUR(id_utilisateur),
    CONSTRAINT fk_msg_bien FOREIGN KEY (id_bien) REFERENCES BIEN(id_bien)
);


CREATE INDEX idx_bien_proprietaire ON BIEN(id_proprietaire);
CREATE INDEX idx_annonce_bien ON ANNONCE(id_bien);
CREATE INDEX idx_reservation_bien ON RESERVATION(id_bien);
CREATE INDEX idx_reservation_locataire ON RESERVATION(id_locataire);
CREATE INDEX idx_location_reservation ON LOCATION(id_reservation);
CREATE INDEX idx_paiement_location ON PAIEMENT(id_location);
CREATE INDEX idx_message_dest ON MESSAGE(id_destinataire);


CREATE ROLE ROLE_VISITEUR;
CREATE ROLE ROLE_STANDARD;
CREATE ROLE ROLE_LOCATAIRE;
CREATE ROLE ROLE_PROPRIETAIRE;
CREATE ROLE ROLE_ADMIN;

-- role visiteur
GRANT SELECT ON VUE_ANNONCES_PUBLIQUES TO ROLE_VISITEUR;
GRANT SELECT ON VUE_BIENS_PUBLICS TO ROLE_VISITEUR;
GRANT SELECT ON VUE_UTILISATEURS_PUBLICS TO ROLE_VISITEUR;
GRANT SELECT ON PHOTO_BIEN TO ROLE_VISITEUR;
GRANT SELECT ON TYPE_EQUIPEMENT TO ROLE_VISITEUR;
GRANT SELECT ON AVIS_BIEN TO ROLE_VISITEUR;

-- role standard
GRANT SELECT ON VUE_MON_PROFIL TO ROLE_STANDARD;
GRANT UPDATE (email, telephone) ON VUE_MON_PROFIL TO ROLE_STANDARD;
GRANT SELECT ON VUE_BIENS_PUBLICS TO ROLE_STANDARD;
GRANT SELECT ON VUE_ANNONCES_PUBLIQUES TO ROLE_STANDARD;
GRANT INSERT, SELECT ON MESSAGE TO ROLE_STANDARD;


-- role locataire
GRANT SELECT ON VUE_ANNONCES_PUBLIQUES TO ROLE_LOCATAIRE; 
GRANT SELECT ON VUE_BIENS_PUBLICS TO ROLE_LOCATAIRE;
GRANT SELECT ON VUE_UTILISATEURS_PUBLICS TO ROLE_LOCATAIRE; 
GRANT UPDATE (email, telephone) ON VUE_MON_PROFIL TO ROLE_LOCATAIRE;
GRANT SELECT ON PHOTO_BIEN TO ROLE_LOCATAIRE;           
GRANT SELECT ON TYPE_EQUIPEMENT TO ROLE_LOCATAIRE;
GRANT SELECT ON VUE_MES_RESERVATIONS TO ROLE_LOCATAIRE;
GRANT INSERT ON RESERVATION TO ROLE_LOCATAIRE; 
GRANT EXECUTE ON creerReservation TO ROLE_LOCATAIRE;
GRANT SELECT ON VUE_MES_PAIEMENTS TO ROLE_LOCATAIRE;
GRANT INSERT ON PAIEMENT TO ROLE_LOCATAIRE;
GRANT INSERT, SELECT ON AVIS_BIEN TO ROLE_LOCATAIRE;

-- role proprietaire

GRANT SELECT ON VUE_ANNONCES_PUBLIQUES TO ROLE_PROPRIETAIRE;
GRANT SELECT ON VUE_BIENS_PUBLICS TO ROLE_PROPRIETAIRE;
GRANT SELECT ON VUE_UTILISATEURS_PUBLICS TO ROLE_PROPRIETAIRE;
GRANT SELECT ON TYPE_EQUIPEMENT TO ROLE_PROPRIETAIRE;
GRANT SELECT ON AVIS_BIEN TO ROLE_PROPRIETAIRE;
GRANT SELECT ON VUE_MES_BIENS TO ROLE_PROPRIETAIRE;
GRANT SELECT ON VUE_MES_ANNONCES TO ROLE_PROPRIETAIRE;
GRANT SELECT ON VUE_RESERVATIONS_POUR_MOI TO ROLE_PROPRIETAIRE;
GRANT SELECT ON VUE_MES_REVENUS TO ROLE_PROPRIETAIRE;
GRANT INSERT, UPDATE, DELETE ON BIEN TO ROLE_PROPRIETAIRE;
GRANT INSERT, UPDATE, DELETE ON ANNONCE TO ROLE_PROPRIETAIRE; 
GRANT INSERT, UPDATE, DELETE ON PHOTO_BIEN TO ROLE_PROPRIETAIRE;
GRANT INSERT, DELETE ON BIEN_EQUIPEMENT TO ROLE_PROPRIETAIRE;
GRANT SELECT ON AVIS_LOCATAIRE TO ROLE_PROPRIETAIRE;
GRANT EXECUTE ON confirmerReservation TO ROLE_PROPRIETAIRE;
GRANT EXECUTE ON creerAnnonce TO ROLE_PROPRIETAIRE;

-- role admin
GRANT ALL ON BIEN TO ROLE_ADMIN;
GRANT ALL ON ANNONCE TO ROLE_ADMIN;
GRANT ALL ON RESERVATION TO ROLE_ADMIN;
GRANT ALL ON LOCATION TO ROLE_ADMIN;
GRANT ALL ON PAIEMENT TO ROLE_ADMIN;
GRANT ALL ON UTILISATEUR TO ROLE_ADMIN;
GRANT ALL ON PROPRIETAIRE TO ROLE_ADMIN;
GRANT ALL ON LOCATAIRE TO ROLE_ADMIN;
GRANT ALL ON PHOTO_BIEN TO ROLE_ADMIN;
GRANT ALL ON AVIS_BIEN TO ROLE_ADMIN;
GRANT ALL ON MESSAGE TO ROLE_ADMIN;